FROM ubuntu:20.04

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð±Ð°Ð·Ð¾Ð²Ñ‹Ñ… Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²
RUN if command -v apt-get >/dev/null 2>&1; then \
        apt-get update && \
        apt-get install -y python3 python3-pip python3-venv lsof net-tools procps psmisc && \
        apt-get clean; \
    elif command -v yum >/dev/null 2>&1; then \
        yum update -y && \
        yum install -y python3 python3-pip lsof net-tools procps-ng psmisc which && \
        yum clean all; \
    elif command -v apk >/dev/null 2>&1; then \
        apk update && \
        apk add --no-cache python3 py3-pip lsof net-tools procps psmisc; \
    fi

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ€Ð°Ð±Ð¾Ñ‡ÐµÐ¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸
WORKDIR /app

# ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¸ÑÑ…Ð¾Ð´Ð½Ð¾Ð³Ð¾ ÐºÐ¾Ð´Ð°
COPY src/ ./src/

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Python
RUN python3 -m pip install --no-cache-dir -r src/requirements.txt || \
    pip3 install --no-cache-dir -r src/requirements.txt

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ‚ÐµÑÑ‚Ð¾Ð²Ð¾Ð³Ð¾ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð°
RUN echo '#!/bin/bash' > test_glacier.sh && \
    echo 'echo "ðŸ” Ð—Ð°Ð¿ÑƒÑÐº Ð°Ð½Ð°Ð»Ð¸Ð·Ð°Ñ‚Ð¾Ñ€Ð° Ð² ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ðµ..."' >> test_glacier.sh && \
    echo 'cd /app' >> test_glacier.sh && \
    echo 'python3 src/glacier.py -w 10 -t 2' >> test_glacier.sh && \
    echo 'echo "ðŸ“„ Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°:"' >> test_glacier.sh && \
    echo 'ls -la *report*.yaml 2>/dev/null || echo "ÐžÑ‚Ñ‡ÐµÑ‚Ñ‹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹"' >> test_glacier.sh && \
    echo 'ls -la *report*.html 2>/dev/null || echo "HTML Ð¾Ñ‚Ñ‡ÐµÑ‚Ñ‹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹"' >> test_glacier.sh && \
    echo 'echo "âœ… Ð¢ÐµÑÑ‚ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½"' >> test_glacier.sh && \
    chmod +x test_glacier.sh

CMD ["./test_glacier.sh"]
