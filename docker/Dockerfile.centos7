FROM centos:7

# Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ñ… Ğ¿Ğ°ĞºĞµÑ‚Ğ¾Ğ²
RUN sed -i 's/mirrorlist/#mirrorlist/g' /etc/yum.repos.d/CentOS-*.repo && \
    sed -i 's|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g' /etc/yum.repos.d/CentOS-*.repo

RUN yum update -y && \
    yum install -y python3 python3-pip python3-devel gcc lsof net-tools procps-ng psmisc which zlib-devel glibc-langpack-en \
    iproute strace tcpdump iputils traceroute telnet bind-utils && \
    yum clean all

# ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ»Ğ¾ĞºĞ°Ğ»Ğ¸ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¸ Unicode
ENV LANG=en_US.UTF-8
ENV LC_ALL=en_US.UTF-8
ENV PYTHONIOENCODING=utf-8

WORKDIR /app

# ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¸ÑÑ…Ğ¾Ğ´Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ´
COPY src/ ./src/

# Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Python (Ğ¸ÑĞºĞ»ÑÑ‡Ğ°Ñ pyinstaller Ğ´Ğ»Ñ CentOS)
RUN python3 -m pip install --no-cache-dir wheel && \
    grep -v pyinstaller src/requirements.txt > /tmp/requirements_centos.txt && \
    python3 -m pip install --no-cache-dir -r /tmp/requirements_centos.txt || \
    pip3 install --no-cache-dir -r /tmp/requirements_centos.txt

# Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ñ€Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ½Ğ¾Ğ³Ğ¾ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ğ¾Ğ³Ğ¾ ÑĞºÑ€Ğ¸Ğ¿Ñ‚Ğ°
RUN echo '#!/bin/bash' > test_trackers.sh && \
    echo 'echo "ğŸ” Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ‚Ñ€ĞµĞºĞµÑ€Ğ¾Ğ² Ğ¸ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ‚Ğ¾Ñ€Ğ° Ğ½Ğ° CentOS 7..."' >> test_trackers.sh && \
    echo 'echo "ğŸ“Š Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ½Ğ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ:"' >> test_trackers.sh && \
    echo 'uname -a' >> test_trackers.sh && \
    echo 'python3 --version' >> test_trackers.sh && \
    echo "" >> test_trackers.sh && \
    echo 'echo "ğŸŒ Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑĞµÑ‚ĞµĞ²Ñ‹Ñ… Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²:"' >> test_trackers.sh && \
    echo 'which lsof netstat ss ping || echo "ĞĞµĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹"' >> test_trackers.sh && \
    echo "" >> test_trackers.sh && \
    echo 'echo "ğŸš€ Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ‚Ğ¾Ñ€Ğ° Ñ Ñ€Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ½Ñ‹Ğ¼ Ñ€ĞµĞ¶Ğ¸Ğ¼Ğ¾Ğ¼..."' >> test_trackers.sh && \
    echo 'cd /app' >> test_trackers.sh && \
    echo 'python3 src/glacier.py -w 15 -t 3' >> test_trackers.sh && \
    echo "" >> test_trackers.sh && \
    echo 'echo "ğŸ“„ ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ²:"' >> test_trackers.sh && \
    echo 'ls -la *report*.yaml *report*.html 2>/dev/null || echo "ĞÑ‚Ñ‡ĞµÑ‚Ñ‹ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹"' >> test_trackers.sh && \
    echo "" >> test_trackers.sh && \
    echo 'echo "ğŸ” ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° YAML Ğ¾Ñ‚Ñ‡ĞµÑ‚Ğ° Ğ½Ğ° Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ Ñ‚Ñ€ĞµĞºĞµÑ€Ğ½Ğ¾Ğ¹ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸:"' >> test_trackers.sh && \
    echo 'if ls *report*.yaml >/dev/null 2>&1; then' >> test_trackers.sh && \
    echo '    for file in *report*.yaml; do' >> test_trackers.sh && \
    echo '        echo "ğŸ“‹ ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ñ„Ğ°Ğ¹Ğ»Ğ°: $$file"' >> test_trackers.sh && \
    echo '        python3 -c "' >> test_trackers.sh && \
    echo 'import yaml, sys' >> test_trackers.sh && \
    echo 'with open("$$file", "r", encoding="utf-8") as f:' >> test_trackers.sh && \
    echo '    data = yaml.safe_load(f)' >> test_trackers.sh && \
    echo 'print("ğŸ“„ Ğ¢Ğ¸Ğ¿ Ğ¾Ñ‚Ñ‡ĞµÑ‚Ğ°:", "NetFlow" if "netflow_message" in data else "Legacy")' >> test_trackers.sh && \
    echo 'if "netflow_message" in data:' >> test_trackers.sh && \
    echo '    flows = data.get("netflow_message", {}).get("flows", [])' >> test_trackers.sh && \
    echo '    stats = data.get("flow_statistics", {})' >> test_trackers.sh && \
    echo '    print("âœ… NetFlow Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ¸:", len(flows))' >> test_trackers.sh && \
    echo '    print("âœ… ĞŸÑ€Ğ¾Ñ‚Ğ¾ĞºĞ¾Ğ»Ñ‹:", list(stats.get("protocols", {}).keys()))' >> test_trackers.sh && \
    echo '    udp_flows = [f for f in flows if f.get("protocol_name") == "udp"]' >> test_trackers.sh && \
    echo '    icmp_flows = [f for f in flows if f.get("protocol_name") == "icmp"]' >> test_trackers.sh && \
    echo '    print("ğŸ”— UDP Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ¸:", len(udp_flows))' >> test_trackers.sh && \
    echo '    print("ğŸ“ ICMP Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ¸:", len(icmp_flows))' >> test_trackers.sh && \
    echo '    non_local_flows = [f for f in flows if "127.0.0.1" not in f.get("source_address", "") and "127.0.0.1" not in f.get("destination_address", "")]' >> test_trackers.sh && \
    echo '    print("ğŸ“¡ Ğ’Ğ½ĞµÑˆĞ½Ğ¸Ğµ ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ñ:", len(non_local_flows))' >> test_trackers.sh && \
    echo 'elif "current_state" in data:' >> test_trackers.sh && \
    echo '    current = data.get("current_state", {})' >> test_trackers.sh && \
    echo '    connections = current.get("connections", {})' >> test_trackers.sh && \
    echo '    udp_traffic = current.get("udp_traffic", {})' >> test_trackers.sh && \
    echo '    icmp_traffic = current.get("icmp_traffic", {})' >> test_trackers.sh && \
    echo '    print("âœ… Ğ’Ñ…Ğ¾Ğ´ÑÑ‰Ğ¸Ğµ ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ñ:", len(connections.get("incoming", [])))' >> test_trackers.sh && \
    echo '    print("âœ… Ğ˜ÑÑ…Ğ¾Ğ´ÑÑ‰Ğ¸Ğµ ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ñ:", len(connections.get("outgoing", [])))' >> test_trackers.sh && \
    echo '    print("ğŸ”— UDP Ñ‚Ñ€Ğ°Ñ„Ğ¸Ğº:", "Ğ½Ğ°Ğ¹Ğ´ĞµĞ½" if udp_traffic else "Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½")' >> test_trackers.sh && \
    echo '    print("ğŸ“ ICMP Ñ‚Ñ€Ğ°Ñ„Ğ¸Ğº:", "Ğ½Ğ°Ğ¹Ğ´ĞµĞ½" if icmp_traffic else "Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½")' >> test_trackers.sh && \
    echo 'else:' >> test_trackers.sh && \
    echo '    print("âš ï¸ ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ¾Ñ‚Ñ‡ĞµÑ‚Ğ°")' >> test_trackers.sh && \
    echo '"' >> test_trackers.sh && \
    echo '    done' >> test_trackers.sh && \
    echo 'fi' >> test_trackers.sh && \
    echo "" >> test_trackers.sh && \
    echo 'echo "âœ… CentOS 7 Ñ‚ĞµÑÑ‚ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½"' >> test_trackers.sh && \
    chmod +x test_trackers.sh

CMD ["./test_trackers.sh"]
